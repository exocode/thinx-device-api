machine:
#  timezone:
#    Europe/Prague

#  ruby:
#    version:
#      2.4.0

  node:
    version:
      5.9.0
#
#  hosts:
#    circlehost: 127.0.0.1
#    dev.mycompany.com: 127.0.0.1
#
# Add some environment variables
#  environment:
#    CIRCLE_ENV: test
#    DATABASE_URL: postgresql://ubuntu:@127.0.0.1:5432/circle_test
#
## Customize checkout
#checkout:
#  post:
#    - git submodule sync
#    - git submodule update --init # use submodules
#
## Customize dependencies
dependencies:
  pre:
    - gem install jasmine
    - npm install -g eslint nyc karma
    - npm install .

  override:
    - bundle install: # note ':' here
        timeout: 180 # fail if command has no output for 3 minutes
        # IMPORTANT NOTE: ^^ the timeout modifier above must be
        # double indented (four spaces) from the previous line

  # cache and restore between builds
  cache_directories:
    - "sessions"
    - "build"
    - "tenants"
    #- "node_modules"

## Customize database setup
database:
  override:
    - bash ./00-init_db_design.sh # requires access to localhost:5984?
#    # replace CircleCI's generated database.yml
#    - cp config/database.yml.ci config/database.yml
#    - bundle exec rake db:create db:schema:load

## Customize test commands
test:
#  override:
#    - phpunit test/unit-tests # use PHPunit for testing
  commands:
    - nohup node index.js > ./logs/thinx.log &
    - bash ./01-analyze.sh
    - bash ./02-deploy.sh
    - bash ./03-test.sh
  post:
    - curl -sSL https://download.sourceclear.com/ci.sh | sh
#    - eslint *.js
    - karma start
    - bundle exec rake jasmine:ci:
      environment:
        RAILS_ENV: test
        RACK_ENV: test
    - cp -v ./coverage $CIRCLE_ARTIFACTS

## Customize deployment commands
deployment:
  staging:
    branch: master
    thinx:
      appname: api

## Custom notifications
notify:
  - curl -X POST --data-urlencode 'payload={"text":"THiNX integration completed."}' https://hooks.slack.com/services/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
